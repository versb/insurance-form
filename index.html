<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Corrected Supabase JS via CDN to use UMD build -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>


    <!-- Initialize Supabase Client -->
    <script>
    // Ensure that the Supabase script has loaded before initializing
    window.addEventListener('load', function() {
        // Your Supabase project URL and anon public key
        const supabaseUrl = 'https://bohetgcagjaqejdtncjr.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJvaGV0Z2NhZ2phcWVqZHRuY2pyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzc1OTQ0MDgsImV4cCI6MjA1MzE3MDQwOH0.ssU_dom5kBRq0MdLl3OiMoyPhZHcGHnIi6lJKjacD6Q';
       
        // Initialize Supabase client
        if (window.supabase) {
            window.supabase = supabase.createClient(supabaseUrl, supabaseKey);
            console.log('Supabase initialized:', window.supabase);
        } else {
            console.error('Supabase library is not loaded.');
        }
    });
    </script>


    <meta charset="UTF-8">
    <title>Insurance Comparison Form</title>
    <style>
      /* Basic Reset */
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }


      /* Body Styling */
      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background-color: #f0f4f7;
        color: #333;
        line-height: 1.6;
        padding: 20px;
      }


      /* Container */
      .container {
        width: 100%;
        max-width: 1000px;
        margin: 0 auto;
        background-color: #ffffff;
        padding: 40px;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      }


      /* Headings */
      h2, h3 {
        text-align: center;
        color: #2c3e50;
        margin-bottom: 20px;
      }


      /* Progress Bar */
      .progress-container {
        width: 100%;
        background-color: #e0e0e0;
        border-radius: 12px;
        margin-bottom: 30px;
        height: 30px;
        position: relative;
        overflow: hidden;
      }


      .progress-bar {
        height: 100%;
        width: 0%;
        background-color: #2980b9;
        text-align: center;
        line-height: 30px;
        color: white;
        transition: width 0.4s ease;
        position: relative;
        z-index: 1;
      }


      .progress-bar::after {
        content: attr(data-percentage);
        position: absolute;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        font-weight: bold;
        color: #ffffff;
        font-size: 14px;
      }


      /* Form Pages */
      .form-page {
        display: none;
      }


      .form-page.active {
        display: block;
      }


      /* Navigation Buttons */
      .navigation-buttons {
        display: flex;
        justify-content: space-between;
        margin-top: 30px;
      }


      .navigation-buttons button {
        padding: 12px 24px;
        border: none;
        background-color: #2980b9;
        color: #ffffff;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
        transition: background-color 0.3s ease;
      }


      .navigation-buttons button:hover:not(:disabled) {
        background-color: #1f6391;
      }


      .navigation-buttons button:disabled {
        background-color: #bdc3c7;
        cursor: not-allowed;
      }


      /* Insurance Policies Logos */
      .insurance-policies {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        justify-content: center;
        margin-top: 20px;
      }


      .insurance-policies .policy {
        width: 120px;
        height: 160px; /* Increased height to accommodate hover effects */
        border: 2px solid #bdc3c7;
        border-radius: 8px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: border-color 0.3s ease, box-shadow 0.3s ease, transform 0.3s ease;
        background-color: #f9f9f9;
        padding: 10px;
      }


      .insurance-policies .policy.selected {
        border-color: #2980b9;
        box-shadow: 0 0 10px rgba(41, 128, 185, 0.5);
      }

      /* Hover Effects for Policies */
      .insurance-policies .policy:hover {
        border-color: #1f6391;
        box-shadow: 0 0 15px rgba(31, 99, 145, 0.3);
        transform: translateY(-5px);
      }


      .insurance-policies .policy img {
        max-width: 80%;
        max-height: 80%;
        margin-bottom: 10px;
        transition: transform 0.3s ease;
      }

      /* Option Images */
      .option {
        position: relative;
        cursor: pointer;
        width: 120px;
        text-align: center;
        border: 2px solid transparent;
        border-radius: 8px;
        transition: border-color 0.3s ease, box-shadow 0.3s ease, transform 0.3s ease;
        background-color: #f9f9f9;
        padding: 10px;
        display: flex;
        flex-direction: column;
        align-items: center;
      }


      .option.selected {
        border-color: #2980b9;
        box-shadow: 0 0 10px rgba(41, 128, 185, 0.5);
      }

      /* Hover Effects for Options */
      .option:hover {
        border-color: #1f6391;
        box-shadow: 0 0 15px rgba(31, 99, 145, 0.3);
        transform: translateY(-5px);
      }


      .option input {
        display: none;
      }


      .option img {
        width: 80px;
        height: 80px;
        object-fit: cover;
        border-radius: 50%;
        margin-bottom: 10px;
        transition: transform 0.3s ease;
      }

      /* Hover effect for option images */
      .option:hover img {
        transform: scale(1.1);
      }


      .option span {
        display: block;
        color: #2c3e50;
        font-weight: bold;
        font-size: 14px;
      }


      /* Qualifying Questions */
      .question {
        margin-bottom: 25px;
      }


      .question label {
        display: block;
        margin-bottom: 10px;
        font-weight: bold;
        color: #2c3e50;
      }


      /* Slider Styling */
      .slider-container {
        display: flex;
        align-items: center;
      }


      .slider-container input[type=range] {
        flex: 1;
        margin-right: 15px;
        height: 5px;
        background: #d3d3d3;
        outline: none;
        border-radius: 5px;
        appearance: none;
      }


      .slider-container input[type=range]::-webkit-slider-thumb {
        appearance: none;
        width: 20px;
        height: 20px;
        background: #2980b9;
        cursor: pointer;
        border-radius: 50%;
        border: none;
        transition: background 0.3s ease;
      }


      .slider-container input[type=range]::-webkit-slider-thumb:hover {
        background: #1f6391;
      }


      .slider-value {
        width: 60px;
        text-align: center;
        font-weight: bold;
        color: #2c3e50;
        font-size: 14px;
      }


      /* Custom Radio Buttons with Images */
      .options-container {
        display: flex;
        gap: 20px;
        flex-wrap: wrap;
        justify-content: center;
        margin-top: 10px;
      }


      /* Text Inputs */
      input[type="text"], input[type="email"], input[type="tel"], select {
        width: 100%;
        padding: 10px;
        margin-top: 5px;
        border: 1px solid #bdc3c7;
        border-radius: 4px;
        font-size: 16px;
        font-family: inherit;
      }


      input[type="text"]:focus, input[type="email"]:focus, input[type="tel"]:focus, select:focus {
        border-color: #2980b9;
        outline: none;
        box-shadow: 0 0 5px rgba(41, 128, 185, 0.5);
      }


      /* Comparison Table */
      #comparison-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
      }


      #comparison-table th,
      #comparison-table td {
        border: 1px solid #bdc3c7;
        padding: 12px;
        text-align: left;
        vertical-align: top;
      }


      #comparison-table th {
        background-color: #ecf0f1;
        color: #2c3e50;
        width: 20%;
      }


      #comparison-table td {
        color: #34495e;
      }


      /* Policy Buttons */
      .policy-button {
        display: inline-block;
        padding: 6px 12px;
        margin: 4px 2px;
        font-size: 14px;
        border: none;
        border-radius: 4px;
        background-color: #2980b9;
        color: #ffffff;
        cursor: default;
      }


      /* Star Ratings */
      .star-rating {
        display: flex;
        align-items: center;
      }


      .star-rating .star {
        color: #f1c40f;
        font-size: 16px;
        margin-right: 2px;
      }


      /* Get a Quote Button */
      .quote-button {
        padding: 8px 16px;
        background-color: #27ae60;
        color: #ffffff;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.3s ease;
      }


      .quote-button:hover {
        background-color: #1e8449;
      }


      /* Popup Modal */
      .modal {
        display: none; /* Hidden by default */
        position: fixed; /* Stay in place */
        z-index: 1000; /* Sit on top */
        left: 0;
        top: 0;
        width: 100%; /* Full width */
        height: 100%; /* Full height */
        overflow: auto; /* Enable scroll if needed */
        background-color: rgba(0,0,0,0.5); /* Black w/ opacity */
      }


      .modal-content {
        background-color: #fefefe;
        margin: 10% auto; /* 10% from the top and centered */
        padding: 20px;
        border: 1px solid #888;
        width: 90%;
        max-width: 500px; /* Could be more or less, depending on screen size */
        border-radius: 8px;
        position: relative;
      }


      .close-modal {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
        position: absolute;
        top: 10px;
        right: 20px;
        cursor: pointer;
      }


      .close-modal:hover,
      .close-modal:focus {
        color: black;
        text-decoration: none;
      }


      /* Quote Form */
      .quote-form .question {
        margin-bottom: 15px;
      }


      .quote-form label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
        color: #2c3e50;
      }


      .quote-form input[type="text"],
      .quote-form input[type="email"],
      .quote-form input[type="tel"],
      .quote-form select {
        width: 100%;
        padding: 8px;
        border: 1px solid #bdc3c7;
        border-radius: 4px;
        font-size: 14px;
        font-family: inherit;
      }


      .quote-form input[type="text"]:focus,
      .quote-form input[type="email"]:focus,
      .quote-form input[type="tel"]:focus,
      .quote-form select:focus {
        border-color: #2980b9;
        outline: none;
        box-shadow: 0 0 5px rgba(41, 128, 185, 0.5);
      }


      .quote-form button {
        padding: 10px 20px;
        background-color: #2980b9;
        color: #ffffff;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
        transition: background-color 0.3s ease;
      }


      .quote-form button:hover {
        background-color: #1f6391;
      }


      /* AI Summary - Empty Green Box */
      #ai-summary {
        background-color: #ecf9f1;
        padding: 20px;
        border-radius: 4px;
        border: 1px solid #a3d9a5;
        color: #2c3e50;
        margin-top: 20px;
        min-height: 100px; /* Ensures the box remains visible even when empty */
        white-space: pre-wrap;
        font-size: 16px;
      }


      /* Responsive Design */
      @media (max-width: 768px) {
        .insurance-policies .policy {
          width: 100px;
          height: 140px; /* Adjusted height for smaller screens */
        }


        .option {
          width: 100px;
        }


        .option img {
          width: 60px;
          height: 60px;
        }


        .slider-value {
          width: 50px;
          font-size: 12px;
        }


        #comparison-table th, #comparison-table td {
          padding: 8px;
          font-size: 14px;
        }


        #ai-summary {
          font-size: 14px;
        }
      }
    </style>
</head>
<body>


  <div class="container">
    <h2>Insurance Comparison Tool</h2>


    <!-- Progress Percentage Bar -->
    <div class="progress-container">
      <div class="progress-bar" id="progress-bar" data-percentage="0%"></div>
    </div>


    <!-- Form Pages -->


    <!-- Page 1: Select Insurance Policies -->
    <div class="form-page active" id="page-1">
      <h3>Step 1: Select Insurance Policies</h3>
      <p>Please select the insurance policies you are interested in comparing:</p>
      <div class="insurance-policies">
        <div class="policy" data-policy="Life">
          <img src="https://i.imgur.com/u3QukPL.png" alt="Life Insurance">
          <span>Life</span>
        </div>
        <div class="policy" data-policy="Income">
          <img src="https://i.imgur.com/BORRLl9.png" alt="Income Protection">
          <span>Income</span>
        </div>
        <div class="policy" data-policy="Health">
          <img src="https://i.imgur.com/GJfL1EV.png" alt="Health Insurance">
          <span>Health</span>
        </div>
        <div class="policy" data-policy="Trauma">
          <img src="https://i.imgur.com/5V503zX.png" alt="Trauma Insurance">
          <span>Trauma</span>
        </div>
        <div class="policy" data-policy="Mortgage">
          <img src="https://i.imgur.com/O2sOWHq.png" alt="Mortgage Insurance">
          <span>Mortgage</span>
        </div>
        <!-- Add more policies as needed -->
      </div>
    </div>


    <!-- Page 2: Qualifying Questions -->
    <div class="form-page" id="page-2">
      <h3>Step 2: Provide Your Information</h3>
      <form id="qualifying-form">
        <div id="dynamic-questions">
          <!-- Dynamic Common Questions will be inserted here -->
        </div>
      </form>
    </div>


    <!-- Page 3: Additional Insurance Details -->
    <div class="form-page" id="page-3">
      <h3>Step 3: Additional Details</h3>
      <form id="additional-details-form">
        <div id="additional-questions">
          <!-- Additional Product-Specific Questions will be inserted here -->
        </div>
      </form>
    </div>


    <!-- Page 4: Comparison & Summary -->
    <div class="form-page" id="page-4">
      <h3>Step 4: Review Your Comparison</h3>
      <div id="comparison-table-container">
        <!-- Dynamic Comparison Table will be inserted here -->
      </div>
      <div id="ai-summary">
        <!-- Future AI-generated summary will be inserted here -->
      </div>
    </div>


    <!-- Navigation Buttons -->
    <div class="navigation-buttons">
      <button type="button" id="back-button" disabled>← Back</button>
      <button type="button" id="next-button">Next →</button>
    </div>
  </div>


  <!-- Popup Modal for Get a Quote -->
  <div id="quote-modal" class="modal">
    <div class="modal-content">
      <span class="close-modal">&times;</span>
      <h3>Get a Quote</h3>
      <form id="quote-form" class="quote-form">
        <div class="question">
          <label for="full_name">Full Name</label>
          <input type="text" id="full_name" name="full_name" placeholder="John Doe" required>
        </div>


        <div class="question">
          <label for="phone_number">Phone Number</label>
          <input type="tel" id="phone_number" name="phone_number" placeholder="(123) 456-7890" required>
        </div>


        <div class="question">
          <label for="email">Email Address</label>
          <input type="email" id="email" name="email" placeholder="john.doe@example.com" required>
        </div>


        <div class="question">
          <label for="region">Region</label>
          <select id="region" name="region" required>
            <option value="" disabled selected>Select your region</option>
            <option value="North">North</option>
            <option value="South">South</option>
            <option value="East">East</option>
            <option value="West">West</option>
            <!-- Add more regions as needed -->
          </select>
        </div>


        <p>
          To provide you with the most accurate and personalized insurance quote, we recommend scheduling a brief consultation with one of our knowledgeable advisors. This meeting will allow us to gather essential information tailored to your needs, ensuring you receive the best coverage options available.
        </p>


        <button type="submit">Submit</button>
      </form>
    </div>
  </div>


  <!-- Questions Data -->
  <script>
    const questionsData = {
      common: [
        {
          id: "age",
          text: "Please select your age:",
          type: "slider",
          min: 18,
          max: 70,
          step: 1,
          required: true
        },
        {
          id: "gender",
          text: "Please select your gender:",
          type: "custom_radio",
          options: ["Male", "Female", "Non-Binary", "Prefer not to say"],
          required: true
        },
        {
          id: "smoked_last_12_months",
          text: "Have you smoked in the last 12 months?",
          type: "custom_radio",
          options: ["Yes", "No"],
          required: true
        },
        {
          id: "significant_health_conditions",
          text: "Do you have any significant health conditions?",
          type: "custom_radio",
          options: ["Yes", "No"],
          required: true
        }
      ],
      specific: [
        {
          id: "life_coverage_amount",
          text: "Desired Life Coverage Amount ($):",
          type: "slider",
          min: 10000,
          max: 1000000,
          step: 1000,
          required: true,
          applicable_policies: ["Life"]
        },
        {
          id: "trauma_cover_amount",
          text: "Desired Trauma Cover Amount ($):",
          type: "slider",
          min: 10000,
          max: 500000,
          step: 1000,
          required: true,
          applicable_policies: ["Trauma"]
        },
        {
          id: "number_dependents",
          text: "Number of Dependents:",
          type: "slider",
          min: 0,
          max: 10,
          step: 1,
          required: false,
          applicable_policies: ["Life"]
        },
        {
          id: "medical_coverage_type",
          text: "Type of Medical Insurance:",
          type: "custom_radio",
          options: ["Individual", "Family"],
          required: true,
          applicable_policies: ["Health"]
        },
        {
          id: "dental_cover",
          text: "Do you want dental coverage?",
          type: "custom_radio",
          options: ["Yes", "No"],
          required: true,
          applicable_policies: ["Health"]
        },
        {
          id: "income_occupation",
          text: "Enter your occupation:",
          type: "text",
          required: true,
          applicable_policies: ["Income"]
        },
        {
          id: "annual_income",
          text: "What is your annual income ($):",
          type: "slider",
          min: 20000,
          max: 200000,
          step: 1000,
          required: true,
          applicable_policies: ["Income"]
        },
        {
          id: "mortgage_amount",
          text: "Mortgage Amount ($):",
          type: "slider",
          min: 50000,
          max: 1000000,
          step: 1000,
          required: true,
          applicable_policies: ["Mortgage"]
        },
        {
          id: "mortgage_term",
          text: "Mortgage Term (Years):",
          type: "slider",
          min: 5,
          max: 30,
          step: 1,
          required: true,
          applicable_policies: ["Mortgage"]
        }
      ]
    };
  </script>


  <!-- JavaScript for Form Handling -->
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      // Form Pages
      const pages = document.querySelectorAll('.form-page');
      let currentPage = 0;


      // Navigation Buttons
      const nextButton = document.getElementById('next-button');
      const backButton = document.getElementById('back-button');


      // Progress Bar
      const progressBar = document.getElementById('progress-bar');
      const totalPages = pages.length;


      // Insurance Policies Selection
      const insurancePolicies = document.querySelectorAll('.insurance-policies .policy');
      let selectedPolicies = [];


      insurancePolicies.forEach(policy => {
        policy.addEventListener('click', () => {
          policy.classList.toggle('selected');
          const policyName = policy.getAttribute('data-policy');
          if (selectedPolicies.includes(policyName)) {
            selectedPolicies = selectedPolicies.filter(item => item !== policyName);
          } else {
            selectedPolicies.push(policyName);
          }


          // Update qualifying questions if on Page 2
          if (currentPage === 1) {
            renderQualifyingQuestions();
          }


          // Update additional questions if on Page 3
          if (currentPage === 2) {
            renderAdditionalDetails();
          }
        });
      });


      // Next Button Click
      nextButton.addEventListener('click', () => {
        if (currentPage === 0) {
          // Validate Page 1
          if (selectedPolicies.length === 0) {
            alert('Please select at least one insurance policy.');
            return;
          }
        } else if (currentPage === 1) {
          // Validate Page 2
          if (!validateQualifyingQuestions()) {
            return;
          }
        } else if (currentPage === 2) {
          // Validate Page 3
          if (!validateAdditionalDetails()) {
            return;
          }
        } else if (currentPage === 3) {
          // Final Step: Open Quote Modal
          openQuoteModal();
          return;
        }


        // Move to next page
        if (currentPage < pages.length - 1) {
          pages[currentPage].classList.remove('active');
          currentPage++;
          pages[currentPage].classList.add('active');
          updateProgressBar();


          // Update button states
          backButton.disabled = false;
          if (currentPage === pages.length - 1) {
            nextButton.textContent = 'Get a Quote';
          } else {
            nextButton.textContent = 'Next →';
          }


          // If moving to Qualifying Questions, render them
          if (currentPage === 1) {
            renderQualifyingQuestions();
          }


          // If moving to Additional Details, render them
          if (currentPage === 2) {
            renderAdditionalDetails();
          }


          // If moving to Comparison & Summary, generate them
          if (currentPage === 3) {
            generateComparison();
          }
        }
      });


      // Back Button Click
      backButton.addEventListener('click', () => {
        if (currentPage > 0) {
          pages[currentPage].classList.remove('active');
          currentPage--;
          pages[currentPage].classList.add('active');
          updateProgressBar();


          // Update button states
          nextButton.textContent = currentPage === pages.length - 1 ? 'Get a Quote' : 'Next →';
          if (currentPage === 0) {
            backButton.disabled = true;
          }


          // If moving back to Qualifying Questions, render them
          if (currentPage === 1) {
            renderQualifyingQuestions();
          }


          // If moving back to Additional Details, render them
          if (currentPage === 2) {
            renderAdditionalDetails();
          }
        }
      });


      // Function to update the progress bar
      function updateProgressBar() {
        const progressPercentage = ((currentPage) / (totalPages - 1)) * 100;
        progressBar.style.width = `${progressPercentage}%`;
        progressBar.setAttribute('data-percentage', `${Math.round(progressPercentage)}%`);
      }


      // Function to render qualifying questions (Page 2)
      function renderQualifyingQuestions() {
        const dynamicQuestionsContainer = document.getElementById('dynamic-questions');
        dynamicQuestionsContainer.innerHTML = ''; // Clear previous questions


        if (selectedPolicies.length === 0) {
          dynamicQuestionsContainer.innerHTML = '<p>No insurance policies selected.</p>';
          return;
        }


        // Render only common questions on Page 2
        const relevantQuestions = questionsData.common;


        // Render each question
        relevantQuestions.forEach(question => {
          const questionDiv = document.createElement('div');
          questionDiv.classList.add('question');


          const label = document.createElement('label');
          label.setAttribute('for', question.id);
          label.textContent = question.text;
          questionDiv.appendChild(label);


          let input;


          switch (question.type) {
            case 'slider':
              const sliderContainer = document.createElement('div');
              sliderContainer.classList.add('slider-container');


              input = document.createElement('input');
              input.type = 'range';
              input.id = question.id;
              input.name = question.id;
              input.min = question.min;
              input.max = question.max;
              input.step = question.step || 1;
              input.value = Math.floor((question.min + question.max) / 2);
              input.required = question.required;


              const sliderValue = document.createElement('span');
              sliderValue.classList.add('slider-value');
              sliderValue.id = `${question.id}-value`;
              sliderValue.textContent = formatNumber(input.value);


              input.addEventListener('input', () => {
                sliderValue.textContent = formatNumber(input.value);
              });


              sliderContainer.appendChild(input);
              sliderContainer.appendChild(sliderValue);
              questionDiv.appendChild(sliderContainer);
              break;


            case 'custom_radio':
              const optionsContainer = document.createElement('div');
              optionsContainer.classList.add('options-container');


              question.options.forEach(option => {
                const optionDiv = document.createElement('div');
                optionDiv.classList.add('option');


                const radioInput = document.createElement('input');
                radioInput.type = 'radio';
                radioInput.id = `${question.id}_${option}`;
                radioInput.name = question.id;
                radioInput.value = option;
                if (question.required) radioInput.required = true;


                const labelImg = document.createElement('label');
                labelImg.setAttribute('for', `${question.id}_${option}`);


                const img = document.createElement('img');
                img.src = getOptionImage(question.id, option);
                img.alt = option;


                const span = document.createElement('span');
                span.textContent = option;


                labelImg.appendChild(img);
                labelImg.appendChild(span);
                optionDiv.appendChild(radioInput);
                optionDiv.appendChild(labelImg);
                optionsContainer.appendChild(optionDiv);


                // Handle selection styling
                labelImg.addEventListener('click', () => {
                  // Remove 'selected' class from siblings
                  const siblings = optionsContainer.querySelectorAll('.option');
                  siblings.forEach(sibling => sibling.classList.remove('selected'));
                  // Add 'selected' class to the clicked option
                  optionDiv.classList.add('selected');
                });
              });


              questionDiv.appendChild(optionsContainer);
              break;


            case 'text':
              input = document.createElement('input');
              input.type = 'text';
              input.id = question.id;
              input.name = question.id;
              input.placeholder = 'e.g., Software Engineer';
              if (question.required) input.required = true;
              questionDiv.appendChild(input);
              break;


            case 'select':
              input = document.createElement('select');
              input.id = question.id;
              input.name = question.id;
              if (question.required) input.required = true;


              const defaultOption = document.createElement('option');
              defaultOption.value = '';
              defaultOption.disabled = true;
              defaultOption.selected = true;
              defaultOption.textContent = 'Select an option';
              input.appendChild(defaultOption);


              question.options.forEach(optionValue => {
                const option = document.createElement('option');
                option.value = optionValue;
                option.textContent = optionValue;
                input.appendChild(option);
              });


              questionDiv.appendChild(input);
              break;


            default:
              input = document.createElement('input');
              input.type = 'text';
              input.id = question.id;
              input.name = question.id;
              input.placeholder = 'Enter your response';
              if (question.required) input.required = true;
              questionDiv.appendChild(input);
          }


          dynamicQuestionsContainer.appendChild(questionDiv);
        });
      }


      // Function to render additional details (Page 3)
      function renderAdditionalDetails() {
        const additionalQuestionsContainer = document.getElementById('additional-questions');
        additionalQuestionsContainer.innerHTML = ''; // Clear previous questions


        if (selectedPolicies.length === 0) {
          additionalQuestionsContainer.innerHTML = '<p>No insurance policies selected.</p>';
          return;
        }


        // Aggregate relevant additional questions
        let relevantAdditionalQuestions = [];


        // Add specific questions based on selected policies
        selectedPolicies.forEach(policy => {
          const specificQs = questionsData.specific.filter(q => q.applicable_policies.includes(policy));
          relevantAdditionalQuestions = relevantAdditionalQuestions.concat(specificQs);
        });


        // Remove duplicate questions based on 'id'
        const uniqueAdditionalQuestions = [];
        const questionIds = new Set();


        relevantAdditionalQuestions.forEach(q => {
          if (!questionIds.has(q.id)) {
            uniqueAdditionalQuestions.push(q);
            questionIds.add(q.id);
          }
        });


        // Render each additional question
        uniqueAdditionalQuestions.forEach(question => {
          const questionDiv = document.createElement('div');
          questionDiv.classList.add('question');


          const label = document.createElement('label');
          label.setAttribute('for', question.id);
          label.textContent = question.text;
          questionDiv.appendChild(label);


          let input;


          switch (question.type) {
            case 'slider':
              const sliderContainer = document.createElement('div');
              sliderContainer.classList.add('slider-container');


              input = document.createElement('input');
              input.type = 'range';
              input.id = question.id;
              input.name = question.id;
              input.min = question.min;
              input.max = question.max;
              input.step = question.step || 1;
              input.value = question.min;
              input.required = question.required;


              const sliderValue = document.createElement('span');
              sliderValue.classList.add('slider-value');
              sliderValue.id = `${question.id}-value`;
              sliderValue.textContent = formatNumber(input.value);


              input.addEventListener('input', () => {
                sliderValue.textContent = formatNumber(input.value);
              });


              sliderContainer.appendChild(input);
              sliderContainer.appendChild(sliderValue);
              questionDiv.appendChild(sliderContainer);
              break;


            case 'custom_radio':
              const optionsContainer = document.createElement('div');
              optionsContainer.classList.add('options-container');


              question.options.forEach(option => {
                const optionDiv = document.createElement('div');
                optionDiv.classList.add('option');


                const radioInput = document.createElement('input');
                radioInput.type = 'radio';
                radioInput.id = `${question.id}_${option}`;
                radioInput.name = question.id;
                radioInput.value = option;
                if (question.required) radioInput.required = true;


                const labelImg = document.createElement('label');
                labelImg.setAttribute('for', `${question.id}_${option}`);


                const img = document.createElement('img');
                img.src = getOptionImage(question.id, option);
                img.alt = option;


                const span = document.createElement('span');
                span.textContent = option;


                labelImg.appendChild(img);
                labelImg.appendChild(span);
                optionDiv.appendChild(radioInput);
                optionDiv.appendChild(labelImg);
                optionsContainer.appendChild(optionDiv);


                // Handle selection styling
                labelImg.addEventListener('click', () => {
                  // Remove 'selected' class from siblings
                  const siblings = optionsContainer.querySelectorAll('.option');
                  siblings.forEach(sibling => sibling.classList.remove('selected'));
                  // Add 'selected' class to the clicked option
                  optionDiv.classList.add('selected');
                });
              });


              questionDiv.appendChild(optionsContainer);
              break;


            case 'text':
              input = document.createElement('input');
              input.type = 'text';
              input.id = question.id;
              input.name = question.id;
              input.placeholder = 'e.g., Software Engineer';
              if (question.required) input.required = true;
              questionDiv.appendChild(input);
              break;


            case 'select':
              input = document.createElement('select');
              input.id = question.id;
              input.name = question.id;
              if (question.required) input.required = true;


              const defaultOption = document.createElement('option');
              defaultOption.value = '';
              defaultOption.disabled = true;
              defaultOption.selected = true;
              defaultOption.textContent = 'Select an option';
              input.appendChild(defaultOption);


              question.options.forEach(optionValue => {
                const option = document.createElement('option');
                option.value = optionValue;
                option.textContent = optionValue;
                input.appendChild(option);
              });


              questionDiv.appendChild(input);
              break;


            default:
              input = document.createElement('input');
              input.type = 'text';
              input.id = question.id;
              input.name = question.id;
              input.placeholder = 'Enter your response';
              if (question.required) input.required = true;
              questionDiv.appendChild(input);
          }


          additionalQuestionsContainer.appendChild(questionDiv);
        });
      }


      // Function to validate qualifying questions (Page 2)
      function validateQualifyingQuestions() {
        const dynamicQuestionsContainer = document.getElementById('dynamic-questions');
        let isValid = true;


        // Validate slider
        const sliderInputs = dynamicQuestionsContainer.querySelectorAll('input[type=range]');
        sliderInputs.forEach(input => {
          if (input.required && !input.value) {
            isValid = false;
            input.style.outline = '2px solid #e74c3c';
          } else {
            input.style.outline = 'none';
          }
        });


        // Validate custom radio buttons
        const customRadios = dynamicQuestionsContainer.querySelectorAll('.options-container');
        customRadios.forEach(container => {
          const selected = container.querySelector('input[type=radio]:checked');
          if (!selected) {
            isValid = false;
            container.style.border = '2px solid #e74c3c';
          } else {
            container.style.border = 'none';
          }
        });


        if (!isValid) {
          alert('Please answer all required questions.');
        }


        return isValid;
      }


      // Function to validate additional details (Page 3)
      function validateAdditionalDetails() {
        const additionalQuestionsContainer = document.getElementById('additional-questions');
        const inputs = additionalQuestionsContainer.querySelectorAll('input, select');
        let isValid = true;


        inputs.forEach(input => {
          if (input.required && !input.value) {
            isValid = false;
            input.style.outline = '2px solid #e74c3c';
          } else {
            input.style.outline = 'none';
          }
        });


        if (!isValid) {
          alert('Please answer all required additional details.');
        }


        return isValid;
      }


      // Function to generate comparison (Page 4)
      function generateComparison() {
        // Collect all data from qualifying and additional forms
        const qualifyingForm = document.getElementById('qualifying-form');
        const qualifyingData = {};
        const qualifyingInputs = qualifyingForm.querySelectorAll('input, select');
        qualifyingInputs.forEach(input => {
          if (input.type === 'range') {
            qualifyingData[input.name] = input.value;
          } else if (input.type === 'radio') {
            if (input.checked) {
              qualifyingData[input.name] = input.value;
            }
          } else {
            qualifyingData[input.name] = input.value;
          }
        });


        const additionalForm = document.getElementById('additional-details-form');
        const additionalData = {};
        const additionalInputs = additionalForm.querySelectorAll('input, select');
        additionalInputs.forEach(input => {
          if (input.type === 'range') {
            additionalData[input.name] = input.value;
          } else if (input.type === 'radio') {
            if (input.checked) {
              additionalData[input.name] = input.value;
            }
          } else {
            additionalData[input.name] = input.value;
          }
        });


        // Combine data
        const allData = { ...qualifyingData, ...additionalData };


        // Determine relevant providers based on selected policies
        const relevantProviders = getRelevantProviders();


        // Populate Comparison Table
        const tableContainer = document.getElementById('comparison-table-container');
        tableContainer.innerHTML = ''; // Clear previous content


        if (relevantProviders.length === 0) {
          tableContainer.innerHTML = '<p>No insurance policies selected.</p>';
        } else {
          const table = document.createElement('table');
          table.id = 'comparison-table';


          // Table Header
          const thead = document.createElement('thead');
          const headerRow = document.createElement('tr');
          ['NZ Insurers for Personal Insurance', 'Policies Offered', 'Reviews', 'Special Offers', 'Financial Stability', 'Get a Quote'].forEach(text => {
            const th = document.createElement('th');
            th.textContent = text;
            headerRow.appendChild(th);
          });
          thead.appendChild(headerRow);
          table.appendChild(thead);


          // Table Body
          const tbody = document.createElement('tbody');
          relevantProviders.forEach(provider => {
            const row = document.createElement('tr');


            // Insurer Name with Logo
            const nameCell = document.createElement('td');
            const logoImg = document.createElement('img');
            logoImg.src = getProviderLogo(provider);
            logoImg.alt = `${provider} Logo`;
            logoImg.style.width = '50px';
            logoImg.style.height = '50px';
            logoImg.style.verticalAlign = 'middle';
            logoImg.style.marginRight = '10px';
            nameCell.appendChild(logoImg);
            const insurerName = document.createElement('span');
            insurerName.textContent = `${provider} Insurance`;
            nameCell.appendChild(insurerName);
            row.appendChild(nameCell);


            // Policies Offered
            const policiesCell = document.createElement('td');
            const policies = getPoliciesOfferedByProvider(provider);
            policies.forEach(policy => {
              const policyButton = document.createElement('span');
              policyButton.classList.add('policy-button');
              policyButton.textContent = policy;
              policiesCell.appendChild(policyButton);
            });
            row.appendChild(policiesCell);


            // Reviews
            const reviewsCell = document.createElement('td');
            const reviews = getReviews(provider);
            const starContainer = document.createElement('div');
            starContainer.classList.add('star-rating');
            for (let i = 1; i <= 5; i++) {
              const star = document.createElement('span');
              star.classList.add('star');
              star.textContent = i <= reviews ? '★' : '☆';
              starContainer.appendChild(star);
            }
            reviewsCell.appendChild(starContainer);
            row.appendChild(reviewsCell);


            // Special Offers
            const offersCell = document.createElement('td');
            const offers = getSpecialOffers(provider);
            offersCell.textContent = offers || 'N/A';
            row.appendChild(offersCell);


            // Financial Stability
            const stabilityCell = document.createElement('td');
            const stability = getFinancialStability(provider);
            stabilityCell.textContent = stability || 'N/A';
            row.appendChild(stabilityCell);


            // Get a Quote Button
            const quoteCell = document.createElement('td');
            const quoteButton = document.createElement('button');
            quoteButton.classList.add('quote-button');
            quoteButton.textContent = 'Get a Quote';
            quoteButton.addEventListener('click', () => {
              openQuoteModal();
            });
            quoteCell.appendChild(quoteButton);
            row.appendChild(quoteCell);


            tbody.appendChild(row);
          });
          table.appendChild(tbody);
          tableContainer.appendChild(table);
        }


        // Populate AI Summary - Left Empty for Future Integration
        document.getElementById('ai-summary').textContent = '';
      }


      // Function to get relevant providers based on selected policies
      function getRelevantProviders() {
        const allProviders = ["AIA", "Fidelity", "Zurich", "Suncorp", "Allianz"];
        const providersOfferingSelectedPolicies = allProviders.filter(provider => {
          const offeredPolicies = getPoliciesOfferedByProvider(provider);
          return selectedPolicies.some(policy => offeredPolicies.includes(policy));
        });
        return providersOfferingSelectedPolicies;
      }


      // Function to get policies offered by a provider (mocked data)
      function getPoliciesOfferedByProvider(provider) {
        const providerPolicies = {
          "AIA": ["Life"],
          "Fidelity": ["Trauma"],
          "Zurich": ["Health"],
          "Suncorp": ["Income", "Mortgage"],
          "Allianz": ["Mortgage"]
        };
        return providerPolicies[provider] || [];
      }


      // Function to get reviews (mocked data)
      function getReviews(provider) {
        const reviews = {
          "AIA": 5,
          "Fidelity": 4,
          "Zurich": 4,
          "Suncorp": 5,
          "Allianz": 4
        };
        return reviews[provider] || 0;
      }


      // Function to get special offers (mocked data)
      function getSpecialOffers(provider) {
        const offers = {
          "AIA": "10% discount on annual premiums",
          "Fidelity": "Free health check-up",
          "Zurich": "",
          "Suncorp": "Extended coverage period",
          "Allianz": "No claim bonus"
        };
        return offers[provider];
      }


      // Function to get financial stability (mocked data)
      function getFinancialStability(provider) {
        const stability = {
          "AIA": "A+",
          "Fidelity": "A",
          "Zurich": "A+",
          "Suncorp": "A+",
          "Allianz": "A"
        };
        return stability[provider] || 'N/A';
      }


      // Utility Function to Format Numbers with $ and Commas
      function formatNumber(number) {
        return Number(number).toLocaleString();
      }


      // Function to get option images based on question ID and option
      function getOptionImage(questionId, option) {
        // Replace the URLs below with actual images representing each option
        const images = {
          "gender_Male": "https://i.imgur.com/swaPosV.png?text=Male",
          "gender_Female": "https://i.imgur.com/fiAHvJv.png?text=Female",
          "gender_Non-Binary": "https://i.imgur.com/4cGTyP2.png?text=Non-Binary",
          "gender_Prefer not to say": "https://i.imgur.com/EV16Om2.png?text=Prefer+Not+to+Say",
          "smoked_last_12_months_Yes": "https://i.imgur.com/9qij3mv.png",
          "smoked_last_12_months_No": "https://i.imgur.com/CPmxUwk.png?text=No",
          "significant_health_conditions_Yes": "https://via.placeholder.com/80.png?text=Yes",
          "significant_health_conditions_No": "https://i.imgur.com/XhSWwDj.png?text=No",
          "medical_coverage_type_Individual": "https://i.imgur.com/PwNFmSW.png?text=Individual",
          "medical_coverage_type_Family": "https://i.imgur.com/NlhTDPK.png?text=Family",
          "dental_cover_Yes": "https://i.imgur.com/Ib0T6pq.png?text=Yes",
          "dental_cover_No": "https://i.imgur.com/EV16Om2.png?text=No"
        };


        return images[`${questionId}_${option}`] || "https://via.placeholder.com/80.png?text=Option";
      }


      // Function to get provider logos based on provider name
      function getProviderLogo(provider) {
        // Replace the URLs below with actual logos of the providers
        const logos = {
          "AIA": "https://via.placeholder.com/100x100.png?text=AIA+Logo",
          "Fidelity": "https://via.placeholder.com/100x100.png?text=Fidelity+Logo",
          "Zurich": "https://via.placeholder.com/100x100.png?text=Zurich+Logo",
          "Suncorp": "https://via.placeholder.com/100x100.png?text=Suncorp+Logo",
          "Allianz": "https://via.placeholder.com/100x100.png?text=Allianz+Logo"
        };


        return logos[provider] || "https://via.placeholder.com/100x100.png?text=Provider+Logo";
      }


      // Function to open Quote Modal
      function openQuoteModal() {
        const modal = document.getElementById('quote-modal');
        modal.style.display = 'block';
      }


      // Function to close Quote Modal
      function closeQuoteModal() {
        const modal = document.getElementById('quote-modal');
        modal.style.display = 'none';
      }


      // Event listener for closing modal
      const closeModalSpan = document.querySelector('.close-modal');
      closeModalSpan.addEventListener('click', closeQuoteModal);


      // Event listener for clicking outside the modal to close it
      window.addEventListener('click', function(event) {
        const modal = document.getElementById('quote-modal');
        if (event.target === modal) {
          closeQuoteModal();
        }
      });


      // Event listener for Quote Form submission
      const quoteForm = document.getElementById('quote-form');
      quoteForm.addEventListener('submit', async function(event) {
        event.preventDefault();


        try {
          // **1. Collect Data from All Forms**


          // Collect data from Page 1: Selected Insurance Policies
          // (Assuming selectedPolicies is already maintained globally)
          if (selectedPolicies.length === 0) {
            alert('Please select at least one insurance policy.');
            return;
          }


          // Collect data from Page 2: Qualifying Questions
          const qualifyingForm = document.getElementById('qualifying-form');
          const qualifyingData = {};
          const qualifyingInputs = qualifyingForm.querySelectorAll('input, select');
          qualifyingInputs.forEach(input => {
            if (input.type === 'range') {
              qualifyingData[input.name] = parseInt(input.value, 10);
            } else if (input.type === 'radio') {
              if (input.checked) {
                // Convert 'Yes'/'No' to boolean where applicable
                if (['smoked_last_12_months', 'significant_health_conditions'].includes(input.name)) {
                  qualifyingData[input.name] = input.value === 'Yes';
                } else {
                  qualifyingData[input.name] = input.value;
                }
              }
            } else {
              qualifyingData[input.name] = input.value;
            }
          });


          // Collect data from Page 3: Additional Insurance Details
          const additionalForm = document.getElementById('additional-details-form');
          const additionalData = {};
          const additionalInputs = additionalForm.querySelectorAll('input, select');
          additionalInputs.forEach(input => {
            if (input.type === 'range') {
              additionalData[input.name] = parseInt(input.value, 10);
            } else if (input.type === 'radio') {
              if (input.checked) {
                // Convert 'Yes'/'No' to boolean where applicable
                if (['dental_cover'].includes(input.name)) {
                  additionalData[input.name] = input.value === 'Yes';
                } else {
                  additionalData[input.name] = input.value;
                }
              }
            } else {
              additionalData[input.name] = input.value;
            }
          });


          // Collect data from Quote Modal: Get a Quote Form
          const quoteData = {
            full_name: document.getElementById('full_name').value.trim(),
            phone_number: document.getElementById('phone_number').value.trim(),
            email: document.getElementById('email').value.trim(),
            region: document.getElementById('region').value
          };


          // **2. Validate Collected Data**
          // Basic validation to ensure required fields are filled
          if (!quoteData.full_name || !quoteData.phone_number || !quoteData.email || !quoteData.region) {
            alert('Please fill in all required fields in the quote form.');
            return;
          }


          // **3. Prepare Data for Insertion**
          const dataToInsert = {
            full_name: quoteData.full_name,
            phone_number: quoteData.phone_number,
            email: quoteData.email,
            region: quoteData.region,
            selected_policies: selectedPolicies,
            age: qualifyingData.age || null,
            gender: qualifyingData.gender || null,
            smoked_last_12_months: qualifyingData.smoked_last_12_months,
            significant_health_conditions: qualifyingData.significant_health_conditions,
            life_coverage_amount: additionalData.life_coverage_amount || null,
            trauma_cover_amount: additionalData.trauma_cover_amount || null,
            number_dependents: additionalData.number_dependents || null,
            medical_coverage_type: additionalData.medical_coverage_type || null,
            dental_cover: additionalData.dental_cover || null,
            income_occupation: additionalData.income_occupation || null,
            annual_income: additionalData.annual_income || null,
            mortgage_amount: additionalData.mortgage_amount || null,
            mortgage_term: additionalData.mortgage_term || null
            // created_at is automatically handled by the database
          };


          // **4. Insert Data into Supabase**
          if (window.supabase) {
            const { data, error } = await window.supabase
              .from('insuranceleads') // Changed to match database table name
              .insert([dataToInsert]);


            // **5. Handle Insertion Result**
            if (error) {
              console.error('Error inserting data:', error);
              if (error.code === '23505') { // Unique violation for email
                alert('The email address provided is already in use. Please use a different email.');
              } else {
                alert('There was an error submitting your information. Please try again later.');
              }
            } else {
              alert('Thank you! Our advisor will contact you shortly.');
              closeQuoteModal();
              resetForm();
            }
          } else {
            console.error('Supabase client is not initialized.');
            alert('Unable to submit data at this time. Please try again later.');
          }


        } catch (err) {
          console.error('Unexpected error:', err);
          alert('An unexpected error occurred. Please try again later.');
        }
      });


      // Function to reset the form after submission
      function resetForm() {
        // Reset all forms
        document.getElementById('qualifying-form').reset();
        document.getElementById('additional-details-form').reset();
        document.getElementById('quote-form').reset();


        // Clear dynamic containers
        document.getElementById('dynamic-questions').innerHTML = '';
        document.getElementById('additional-questions').innerHTML = '';
        document.getElementById('comparison-table-container').innerHTML = '';
        document.getElementById('ai-summary').innerHTML = '';


        // Deselect all policies
        insurancePolicies.forEach(policy => {
          policy.classList.remove('selected');
        });
        selectedPolicies = [];


        // Reset to first page
        pages.forEach(page => page.classList.remove('active'));
        pages[0].classList.add('active');
        currentPage = 0;


        // Reset progress bar
        updateProgressBar();


        // Reset buttons
        backButton.disabled = true;
        nextButton.textContent = 'Next →';
      }


      // Initial Progress Bar Update
      updateProgressBar();
    });
  </script>


</body>
</html>

